var e=Object.defineProperty,t=(t,n,r)=>(((t,n,r)=>{n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[n]=r})(t,"symbol"!=typeof n?n+"":n,r),r);function n(e){const t=document.getElementById(e);if(!t)throw new Error("Element not found, make sure ID's match and that the element is in the DOM");return t}async function r(e,t){let n=!1;for(;!n;){let{done:r,value:i}=await e.read();if(r)n=!0;else{if(void 0===i)throw new Error("No value present while simultaneously not done with reading");t(i)}}}function i(e,t,n){const r=document.createElement("a");r.href=`${t},${e}`,r.download=n,r.click()}function o(e,t){return e>Math.pow(2,t)-1}!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver((e=>{for(const n of e)if("childList"===n.type)for(const e of n.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)})).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const a={unsigned_32_bit(e){if(o(e,32))throw new Error("Number would overflow");const t=new Uint8Array(4);return t[0]=e>>24,t[1]=e>>16,t[2]=e>>8,t[3]=e,t},unsigned_16_bit(e){if(o(e,16))throw new Error("Number would overflow");const t=new Uint8Array(2);return t[0]=e>>8,t[1]=e,t},variable_length(e){let t=[];do{let n=127&e;t.length>0&&(n|=128),t.unshift(n),e>>=7}while(e>0);return new Uint8Array(t)}};function s(e){let t=0;for(let n=0;n<e.length;n++)t+=e[n]<<8*n;return t}const l=6,d=8,c=480,u=67,h=141,p={note_off(e,t,n){const r=new Uint8Array(3);return r[0]=128|e,r[1]=t,r[2]=n,r},note_on(e,t,n){const r=new Uint8Array(3);return r[0]=144|e,r[1]=t,r[2]=n,r},polyphonic_key_pressure(e,t,n){const r=new Uint8Array(3);return r[0]=160|e,r[1]=t,r[2]=n,r},control_change(e,t,n){const r=new Uint8Array(3);return r[0]=176|e,r[1]=t,r[2]=n,r},program_change(e,t){const n=new Uint8Array(2);return n[0]=192|e,n[1]=t,n},channel_pressure(e,t){const n=new Uint8Array(2);return n[0]=208|e,n[1]=t,n},pitch_wheel_change(e,t){const n=new Uint8Array(3);return n[0]=224|e,n[1]=127&t,n[2]=t>>7&127,n}};function f(e){let t=[];return Object.entries(e.pattern_events).forEach((([e,n])=>{Object.entries(n).forEach((([n,r])=>{const i=function(e,t,n){0;const r=new Uint8Array(14);if(r.set(m(0,l)),r[8]=e>>8&255,r[9]=255&e,r.set(a.unsigned_16_bit(t),10),o(n,15))throw new Error("Ticks per quarter note would overflow the maximum 15 bits");return r.set(a.unsigned_16_bit(n),12),r}(0,1,c),s=function(e){const t=m(1,function(e){const t=e.reduce(((e,t)=>e+t.event.length+a.variable_length(t.v_time).length),0);return t}(e));let n=8;return e.forEach((e=>{const r=a.variable_length(e.v_time);t.set(r,n),n+=r.length,t.set(e.event,n),n+=e.event.length})),t}(r),d=new Uint8Array(i.length+s.length);d.set(i,0),d.set(s,i.length),t.push({data:d,bank_layer:Number(e),pad:Number(n)})}))})),t}class _{constructor(){t(this,"pattern_events"),this.pattern_events={},this.process_value=this.process_value.bind(this)}process_value(e){const t=e.slice(0,-16);let n=0;for(let o=0;o<t.length;o+=8){const e=t.slice(o,o+8),a=(i=void 0,{ticks_since_last_event:(r=e)[0],pad_pressed:r[1],bank:r[2],pitch:r[3]?(i=r[3],i-h+u):u,velocity:r[4],hold_time:s(r.slice(-2))});n+=a.ticks_since_last_event,Object.prototype.hasOwnProperty.call(this.pattern_events,a.bank)||(this.pattern_events[a.bank]={}),Object.prototype.hasOwnProperty.call(this.pattern_events[a.bank],a.pad_pressed)||(this.pattern_events[a.bank][a.pad_pressed]=[]);const l=this.pattern_events[a.bank][a.pad_pressed][-1];let d;d=l?n-l.v_time:n,this.pattern_events[a.bank][a.pad_pressed].push(b(d,p.note_on(1,a.pitch,a.velocity))),this.pattern_events[a.bank][a.pad_pressed].push(b(d+a.hold_time,p.note_off(1,a.pitch,a.velocity)))}var r,i;if(e.slice(-16)[14]*(4*c)!==n)throw new Error("Amount of ticks present in patterns does not match the incoming patterns bar length")}}function b(e,t){return{v_time:e,event:t}}function m(e,t){const n=a.unsigned_32_bit(t),r=new Uint8Array(d+t);switch(e){case 0:r[0]="M".charCodeAt(0),r[1]="T".charCodeAt(0),r[2]="h".charCodeAt(0),r[3]="d".charCodeAt(0);break;case 1:r[0]="M".charCodeAt(0),r[1]="T".charCodeAt(0),r[2]="r".charCodeAt(0),r[3]="k".charCodeAt(0);break;default:throw new Error("Attempted to create a midi chunk with a type which is unimplemented")}return r.set(n,4),r}const g={0:"A",1:"B",2:"C",3:"D",4:"E",5:"F",6:"G",7:"H",8:"I",9:"J"};class w{constructor(){t(this,"bank_info"),this.bank_info={},this.process_value=this.process_value.bind(this)}process_value(e){const t=e.slice(128,152);console.log(t);for(let n=0;n<10;n++){const t=27680+384*n,r=g[n];Object.prototype.hasOwnProperty.call(this.bank_info,r)||(this.bank_info[r]={});const i=e.slice(t,t+384);if(255!==i[0])for(let e=0;e<384;e+=24){const t=e/24,n=i.slice(e,e+24),o=n.findIndex((e=>0===e)),a=n.slice(0,o),s=(new TextDecoder).decode(a);"                       \0"!==s&&(this.bank_info[r][t]=s)}}console.log(this.bank_info)}}const v={midi_event_builder:null,pad_config_builder:null,current_pattern_reader:null,current_pad_config_reader:null},y=47,k=16,A=128;function E(e){if(!e.target)throw new Error("Failed to access event target");const t=e.target.files;if(!t)throw new Error("Files undefined on event target. make sure input is a file input type");return t[0].stream().getReader()}function C(e,t){if(!e.target)throw new Error("Failed to access event target");const n=e.target.files;if(!n)throw new Error("Files undefined on event target. make sure input is a file input type");n.length?t.disabled=!1:t.disabled=!0}function O(e,t,n){e.addEventListener("mousedown",(()=>{const e=document.createElement("input");e.type="file",e.addEventListener("change",(e=>{const t=E(e);v.current_pattern_reader=t,C(e,n)})),e.click()})),t.addEventListener("mousedown",(()=>{console.log("sleet");const e=document.createElement("input");e.type="file",e.addEventListener("change",(e=>{const t=E(e);v.current_pad_config_reader=t,C(e,n)})),e.click()})),n.addEventListener("mousedown",(async()=>{var e,t;if(v.midi_event_builder=new _,v.pad_config_builder=new w,!v.current_pattern_reader)throw new Error("No current reader set");let n=[];v.current_pad_config_reader&&n.push(r(v.current_pad_config_reader,null==(e=v.pad_config_builder)?void 0:e.process_value)),n.push(r(v.current_pattern_reader,null==(t=v.midi_event_builder)?void 0:t.process_value)),await Promise.all(n),function(){if(!v.midi_event_builder)throw new Error("Attempted to download midi files that are not built yet. make sure to build midi files before attempting to call this function");f(v.midi_event_builder).forEach((e=>{var t;if(Number(e.pad)===A)return;const n=btoa(String.fromCharCode(...e.data)),r=1===e.bank_layer?5:0,o=Math.floor((e.pad-y)/k)+r,a=(e.pad-y)%k,s=g[o];v.pad_config_builder&&0!==Object.keys(v.pad_config_builder.bank_info).length?i(n,"data:audio/midi;base64",`${s}-${null==(t=v.pad_config_builder)?void 0:t.bank_info[s][a]}`):i(n,"data:audio/midi;base64",`${s}-${a+1}`)}))}()}))}const U="pattern_file_upload",N="pad_config_file_upload",P="build_midi_files";n("app").innerHTML=`\n    <img src="bg_img.png" width="600" id="bg_img" />\n    <div id="outer_container">\n      <div id="inner_container">\n        <h2>SP404 Midi File Generator 0.1</h2>\n        <button id="${U}">Upload Pattern Bin File</button>\n        <button id="${N}">Upload Pad Config File - Optional</button>\n        <button disabled id="${P}">Save As Midi Files</button>\n        <div class="text_container" id="instructions_container">\n          <h4>Usage</h4>\n          <p>\n            1: Click the "Upload Pattern Bin File" button and select your pattern bin you wish to generate midi files for.\n            <br/>\n            <br/>\n            2: Optionally, Click the "Upload Pad Config File" button and select your projects PADCONF.BIN file. This lets us build better file names for you including the sample name.\n            <br/>\n            <br/>\n            3: Click the "Save As Midi Files" button.\n            <br/>\n            <br/>\n            Midi files will be downloaded individually.\n            If a pad config file was uploaded, the file names will be as follows\n            <br/>\n            <br/>\n            <b>"{BANK_NAME}_{SAMPLE_NAME}.mid"</b>\n            <br/>\n            <br/>\n            Otherwise, file names will be as follows. \n            <br/>\n            <br/>\n            <b>"{BANK_NAME}_{PAD_ID}.mid"</b>\n          </p>\n        </div>\n        <hr />\n        <div class="text_container" id="blurb">\n          <p>\n            Half way through developing this, I found out that Rolands SP404mk2 application does export to midi.\n            But it exports all pads to one midi file which annoyed me while trying to get projects into a daw.\n            So this project exports each pad as an individual midi pattern.\n          </p>\n          <p>\n            This is very much a work in progress and has not been battle tested, If you find any bugs, or would like a\n            feature added, please submit an issue in <a href="https://github.com/TheDevCactus/sp404mk2_midi_file_generator/issues/new/choose">GitHub</a>.\n          </p>\n        </div>\n      </div>\n    </div>\n    <footer>\n      <a href="https://buymeacoffee.com/morgan_brown">Throw me a dollar</a>\n      <a href="https://thedevcactus.github.io/SamplerBlog/">Cheap Sampler/Groove box project</a>\n      <a href="https://github.com/TheDevCactus/sp404mk2_midi_file_generator">My Github (sourcecode for this site)</a>\n    </footer>\n  `,O(n(U),n(N),n(P));
